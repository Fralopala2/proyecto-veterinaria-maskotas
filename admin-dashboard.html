<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Administrativo - MASK!OTAS</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(45deg, #2c3e50, #3498db);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        padding: 30px;
        background: #f8f9fa;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 10px;
      }

      .stat-label {
        font-size: 1.1em;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .content-section {
        padding: 30px;
      }

      .section-title {
        font-size: 1.8em;
        color: #2c3e50;
        margin-bottom: 20px;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 30px;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
      }

      .data-table th {
        background: #34495e;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
      }

      .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
      }

      .data-table tr:hover {
        background: #f8f9fa;
      }

      .refresh-btn {
        background: linear-gradient(45deg, #27ae60, #2ecc71);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        margin-bottom: 20px;
        transition: all 0.3s ease;
      }

      .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
      }

      .loading {
        text-align: center;
        padding: 50px;
        font-size: 1.2em;
        color: #666;
      }

      .error {
        background: #e74c3c;
        color: white;
        padding: 15px;
        border-radius: 5px;
        margin: 20px 0;
        text-align: center;
      }

      .timestamp {
        text-align: center;
        color: #666;
        font-style: italic;
        margin-top: 20px;
      }

      .no-data {
        text-align: center;
        color: #666;
        font-style: italic;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üêæ MASK!OTAS Dashboard</h1>
        <p>Panel de An√°lisis de Usuarios y Conexiones</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">-</div>
          <div class="stat-label">Total Usuarios</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCountries">-</div>
          <div class="stat-label">Pa√≠ses</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCities">-</div>
          <div class="stat-label">Ciudades</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="recentUsers">-</div>
          <div class="stat-label">Registros (7 d√≠as)</div>
        </div>
      </div>

      <div class="content-section">
        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <button class="refresh-btn" onclick="loadDashboardData()">
            üîÑ Actualizar Datos
          </button>
          <button
            class="refresh-btn"
            onclick="testServerConnection()"
            style="background: linear-gradient(45deg, #3498db, #2980b9)"
          >
            üåê Probar Conexi√≥n AWS
          </button>
        </div>

        <div id="loading" class="loading" style="display: none">
          Cargando datos del dashboard...
        </div>

        <div id="error" class="error" style="display: none"></div>

        <div id="dashboardContent">
          <!-- Content will be loaded here -->
        </div>

        <div id="timestamp" class="timestamp"></div>
      </div>
    </div>

    <script>
      async function loadDashboardData() {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const content = document.getElementById("dashboardContent");

        loading.style.display = "block";
        error.style.display = "none";
        content.innerHTML = "";

        try {
          let result;

          try {
            const response = await fetch(
              "/api/dashboard-data-stored-procedures.php"
            );
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }
            result = await response.json();

            if (!result.success) {
              throw new Error(result.error || "Error desconocido");
            }
          } catch (fetchError) {
            console.warn(
              "Servidor AWS no disponible, usando datos de demostraci√≥n:",
              fetchError.message
            );

            // Datos de fallback para demostraci√≥n
            result = {
              success: true,
              data: {
                totalUsers: 25,
                totalCountries: 9,
                totalCities: 13,
                recentUsers: [
                  {
                    username: "SoniaPucheta",
                    city_name: "Valencia",
                    country_name: "Espa√±a",
                    registration_date: "2025-10-06 07:31:30",
                  },
                  {
                    username: "PacoLopez",
                    city_name: "Madrid",
                    country_name: "Espa√±a",
                    registration_date: "2025-10-06 07:29:15",
                  },
                  {
                    username: "TestUser",
                    city_name: "Barcelona",
                    country_name: "Espa√±a",
                    registration_date: "2025-10-06 07:25:20",
                  },
                ],
                usersByCountryAndCity: [
                  {
                    country_name: "Espa√±a",
                    city_name: "Madrid",
                    user_count: "6",
                  },
                  {
                    country_name: "Espa√±a",
                    city_name: "Valencia",
                    user_count: "4",
                  },
                  {
                    country_name: "Espa√±a",
                    city_name: "Barcelona",
                    user_count: "3",
                  },
                  {
                    country_name: "Francia",
                    city_name: "Par√≠s",
                    user_count: "2",
                  },
                  {
                    country_name: "Italia",
                    city_name: "Roma",
                    user_count: "2",
                  },
                  {
                    country_name: "Alemania",
                    city_name: "Berl√≠n",
                    user_count: "1",
                  },
                ],
                countryWithMostUsers: [
                  { country_name: "Espa√±a", user_count: "13" },
                ],
                citiesConcentrating90Percent: [
                  {
                    country_name: "Espa√±a",
                    city_name: "Madrid",
                    city_user_count: "6",
                    concentration_percentage: "46.15",
                  },
                  {
                    country_name: "Espa√±a",
                    city_name: "Valencia",
                    city_user_count: "4",
                    concentration_percentage: "30.77",
                  },
                  {
                    country_name: "Francia",
                    city_name: "Par√≠s",
                    city_user_count: "2",
                    concentration_percentage: "100.00",
                  },
                  {
                    country_name: "Italia",
                    city_name: "Roma",
                    city_user_count: "2",
                    concentration_percentage: "100.00",
                  },
                ],
                averageConnectionTime: [
                  {
                    country_name: "Espa√±a",
                    avg_connection_minutes: "245.50",
                    active_users_last_month: "13",
                  },
                  {
                    country_name: "Francia",
                    avg_connection_minutes: "180.25",
                    active_users_last_month: "2",
                  },
                  {
                    country_name: "Italia",
                    avg_connection_minutes: "120.75",
                    active_users_last_month: "2",
                  },
                  {
                    country_name: "Alemania",
                    avg_connection_minutes: "90.00",
                    active_users_last_month: "1",
                  },
                ],
              },
              generated_at: new Date().toLocaleString("es-ES"),
              fallback_mode: true,
            };

            // Mostrar aviso de modo demostraci√≥n
            const demoNotice = document.createElement("div");
            demoNotice.style.cssText =
              "background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;";
            demoNotice.innerHTML =
              "‚ö†Ô∏è <strong>Modo Demostraci√≥n:</strong> El servidor AWS no est√° disponible. Mostrando datos de ejemplo de los procedimientos almacenados.";
            content.appendChild(demoNotice);
          }

          const data = result.data;

          // Update stats
          document.getElementById("totalUsers").textContent =
            data.totalUsers || 0;
          document.getElementById("totalCountries").textContent =
            data.totalCountries || 0;
          document.getElementById("totalCities").textContent =
            data.totalCities || 0;
          document.getElementById("recentUsers").textContent =
            data.recentUsers?.length || 0;

          // Build content sections with clear task identification
          let html = "";

          // Header with task information
          html +=
            '<div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 30px;">';
          html +=
            '<h2 style="color: #2c3e50; margin-bottom: 15px;">üìã Tarea 2 - Procedimientos Almacenados</h2>';
          html +=
            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
          html +=
            '<div><h4 style="color: #27ae60;">‚úÖ Nivel F√°cil:</h4><ul><li>Usuarios por pa√≠s y ciudad</li><li>Pa√≠s con m√°s usuarios</li></ul></div>';
          html +=
            '<div><h4 style="color: #e74c3c;">üî• Nivel Dif√≠cil:</h4><ul><li>Ciudades con 90% concentraci√≥n</li><li>Tiempo promedio de conexi√≥n</li></ul></div>';
          html += "</div></div>";

          // NIVEL F√ÅCIL
          html +=
            '<div style="border: 3px solid #27ae60; border-radius: 10px; padding: 20px; margin-bottom: 30px;">';
          html +=
            '<h2 class="section-title" style="color: #27ae60;">‚úÖ NIVEL F√ÅCIL - Stored Procedures</h2>';

          // 1. Users by Country and City (SP_UsersByCountryAndCity)
          html +=
            '<h3 style="color: #2c3e50; margin-top: 25px;">üë• 1. Para cada pa√≠s, ciudades con usuarios registrados y cu√°ntos</h3>';
          html +=
            '<p style="font-style: italic; color: #666; margin-bottom: 15px;">Procedimiento: <code>SP_UsersByCountryAndCity()</code></p>';
          if (
            data.usersByCountryAndCity &&
            data.usersByCountryAndCity.length > 0
          ) {
            html += '<table class="data-table">';
            html +=
              "<thead><tr><th>Pa√≠s</th><th>Ciudad</th><th>Usuarios</th></tr></thead><tbody>";
            data.usersByCountryAndCity.forEach((row) => {
              html += `<tr><td>${row.country_name}</td><td>${row.city_name}</td><td><strong>${row.user_count}</strong></td></tr>`;
            });
            html += "</tbody></table>";
          } else {
            html += '<div class="no-data">No hay datos disponibles</div>';
          }

          // 2. Country with Most Users (SP_CountryWithMostUsers)
          html +=
            '<h3 style="color: #2c3e50; margin-top: 25px;">üèÜ 2. Pa√≠s con mayor n√∫mero de usuarios</h3>';
          html +=
            '<p style="font-style: italic; color: #666; margin-bottom: 15px;">Procedimiento: <code>SP_CountryWithMostUsers()</code></p>';
          if (
            data.countryWithMostUsers &&
            data.countryWithMostUsers.length > 0
          ) {
            const topCountry = data.countryWithMostUsers[0];
            html += `<div class="stat-card" style="max-width: 400px; margin: 0 auto; border: 2px solid #27ae60;">`;
            html += `<div class="stat-number" style="color: #27ae60;">${topCountry.user_count}</div>`;
            html += `<div class="stat-label">${topCountry.country_name}</div>`;
            html += `</div>`;
          } else {
            html += '<div class="no-data">No hay datos disponibles</div>';
          }
          html += "</div>";

          // NIVEL DIF√çCIL
          html +=
            '<div style="border: 3px solid #e74c3c; border-radius: 10px; padding: 20px; margin-bottom: 30px;">';
          html +=
            '<h2 class="section-title" style="color: #e74c3c;">üî• NIVEL DIF√çCIL - Stored Procedures</h2>';

          // 3. Cities Concentrating 90% Users (SP_CitiesConcentrating90PercentUsers)
          html +=
            '<h3 style="color: #2c3e50; margin-top: 25px;">üèôÔ∏è 1. Ciudades que concentran el 90% de usuarios</h3>';
          html +=
            '<p style="font-style: italic; color: #666; margin-bottom: 15px;">Procedimiento: <code>SP_CitiesConcentrating90PercentUsers()</code></p>';
          if (
            data.citiesConcentrating90Percent &&
            data.citiesConcentrating90Percent.length > 0
          ) {
            html += '<table class="data-table">';
            html +=
              "<thead><tr><th>Pa√≠s</th><th>Ciudad</th><th>Usuarios</th><th>% Concentraci√≥n</th></tr></thead><tbody>";
            data.citiesConcentrating90Percent.forEach((row) => {
              const percentage = row.concentration_percentage
                ? parseFloat(row.concentration_percentage).toFixed(2)
                : "N/A";
              html += `<tr><td>${row.country_name}</td><td>${row.city_name}</td><td><strong>${row.city_user_count}</strong></td><td><strong>${percentage}%</strong></td></tr>`;
            });
            html += "</tbody></table>";
          } else {
            html +=
              '<div class="no-data">No hay ciudades que cumplan el criterio del 90%</div>';
          }

          // 4. Average Connection Time (SP_AverageConnectionTimeByCountry)
          html +=
            '<h3 style="color: #2c3e50; margin-top: 25px;">‚è±Ô∏è 2. Tiempo promedio de conexi√≥n por pa√≠s (√∫ltimo mes)</h3>';
          html +=
            '<p style="font-style: italic; color: #666; margin-bottom: 15px;">Procedimiento: <code>SP_AverageConnectionTimeByCountry()</code></p>';
          if (
            data.averageConnectionTime &&
            data.averageConnectionTime.length > 0
          ) {
            html += '<table class="data-table">';
            html +=
              "<thead><tr><th>Pa√≠s</th><th>Tiempo Promedio (minutos)</th><th>Usuarios Activos</th></tr></thead><tbody>";
            data.averageConnectionTime.forEach((row) => {
              const avgTime = row.avg_connection_minutes
                ? parseFloat(row.avg_connection_minutes).toFixed(2)
                : "N/A";
              const activeUsers = row.active_users_last_month || 0;
              html += `<tr><td>${row.country_name}</td><td><strong>${avgTime}</strong></td><td>${activeUsers}</td></tr>`;
            });
            html += "</tbody></table>";
          } else {
            html +=
              '<div class="no-data">No hay datos de conexi√≥n disponibles</div>';
          }
          html += "</div>";

          // Recent Users
          html +=
            '<h2 class="section-title">üÜï Registros Recientes (√öltimos 7 d√≠as)</h2>';
          if (data.recentUsers && data.recentUsers.length > 0) {
            html += '<table class="data-table">';
            html +=
              "<thead><tr><th>Usuario</th><th>Ciudad</th><th>Pa√≠s</th><th>Fecha de Registro</th></tr></thead><tbody>";
            data.recentUsers.forEach((row) => {
              const date = new Date(row.registration_date).toLocaleDateString(
                "es-ES"
              );
              html += `<tr><td>${row.username}</td><td>${row.city_name}</td><td>${row.country_name}</td><td>${date}</td></tr>`;
            });
            html += "</tbody></table>";
          } else {
            html += '<div class="no-data">No hay registros recientes</div>';
          }

          content.innerHTML = html;

          // Mostrar informaci√≥n del estado
          const statusInfo = result.fallback_mode
            ? `Modo Demostraci√≥n - ${result.generated_at} (Servidor AWS no disponible)`
            : `Datos en Vivo - ${result.generated_at}`;

          document.getElementById(
            "timestamp"
          ).textContent = `√öltima actualizaci√≥n: ${statusInfo}`;
        } catch (err) {
          error.innerHTML = `
                    <strong>Error al cargar los datos:</strong> ${err.message}<br>
                    <small>Esto puede ocurrir si el servidor AWS est√° apagado o la IP ha cambiado. 
                    Los datos de demostraci√≥n deber√≠an cargarse autom√°ticamente.</small>
                `;
          error.style.display = "block";
          console.error("Dashboard error:", err);
        } finally {
          loading.style.display = "none";
        }
      }

      // Funci√≥n para probar conexi√≥n al servidor
      async function testServerConnection() {
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = "üîÑ Probando...";
        button.disabled = true;

        try {
          const response = await fetch(
            "/api/dashboard-data-stored-procedures.php",
            {
              method: "GET",
              timeout: 5000,
            }
          );

          if (response.ok) {
            alert(
              "‚úÖ Conexi√≥n exitosa al servidor AWS!\nActualizando datos..."
            );
            loadDashboardData();
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          alert(
            `‚ùå Servidor AWS no disponible:\n${error.message}\n\nPosibles causas:\n‚Ä¢ Instancia EC2 apagada\n‚Ä¢ IP cambiada\n‚Ä¢ Problemas de red`
          );
        } finally {
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }

      // Load data when page loads
      document.addEventListener("DOMContentLoaded", loadDashboardData);

      // Auto-refresh every 5 minutes
      setInterval(loadDashboardData, 300000);
    </script>
  </body>
</html>
