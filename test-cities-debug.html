<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Ciudades</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 15px;
        margin: 5px;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
      }
      select {
        width: 200px;
        padding: 5px;
        margin: 5px;
      }
    </style>
  </head>
  <body>
    <h1>Debug - Carga de Ciudades</h1>

    <div class="test-section">
      <h2>Test 1: API Directa</h2>
      <button onclick="testDirectAPI()">Probar API Directa</button>
      <div id="directResult" class="log"></div>
    </div>

    <div class="test-section">
      <h2>Test 2: Con Proxy</h2>
      <button onclick="testWithProxy()">Probar Con Proxy</button>
      <div id="proxyResult" class="log"></div>
    </div>

    <div class="test-section">
      <h2>Test 3: Función loadCities</h2>
      <select id="testCountry">
        <option value="">Selecciona país</option>
        <option value="ESP">España (ESP)</option>
        <option value="USA">Estados Unidos (USA)</option>
        <option value="FRA">Francia (FRA)</option>
      </select>
      <button onclick="testLoadCities()">Probar loadCities</button>
      <select id="testCities">
        <option value="">Ciudades aparecerán aquí</option>
      </select>
      <div id="loadCitiesResult" class="log"></div>
    </div>

    <script src="js/countries-fallback.js"></script>
    <script>
      // Copiar las funciones necesarias del auth-modals.js
      const CORS_PROXIES = [
        "https://api.allorigins.win/get?url=",
        "https://corsproxy.io/?",
        "https://api.codetabs.com/v1/proxy?quest=",
      ];

      async function fetchWithProxy(url) {
        const isHTTPS = window.location.protocol === "https:";

        if (!isHTTPS) {
          const response = await fetch(url);
          return await response.json();
        }

        for (let i = 0; i < CORS_PROXIES.length; i++) {
          const proxy = CORS_PROXIES[i];
          try {
            console.log(
              `Intentando proxy ${i + 1}/${CORS_PROXIES.length}: ${proxy}`
            );

            const proxyURL = proxy + encodeURIComponent(url);
            const response = await fetch(proxyURL);

            if (!response.ok) {
              throw new Error(`HTTP ${response.status}`);
            }

            let data = await response.json();

            if (data.contents) {
              data = JSON.parse(data.contents);
            } else if (data.body) {
              data = JSON.parse(data.body);
            }

            console.log(`Éxito con proxy ${i + 1}`);
            return data;
          } catch (error) {
            console.log(`Proxy ${i + 1} falló:`, error.message);
            if (i === CORS_PROXIES.length - 1) {
              throw new Error(
                `Todos los proxies fallaron. Último error: ${error.message}`
              );
            }
          }
        }
      }

      async function testDirectAPI() {
        const result = document.getElementById("directResult");
        result.innerHTML = "Probando...";

        try {
          const response = await fetch(
            "http://54.167.110.190/api/get-cities.php?country=ESP"
          );
          const data = await response.json();
          result.innerHTML = `<strong>Éxito:</strong><br>${JSON.stringify(
            data,
            null,
            2
          )}`;
        } catch (error) {
          result.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
      }

      async function testWithProxy() {
        const result = document.getElementById("proxyResult");
        result.innerHTML = "Probando con proxy...";

        try {
          const data = await fetchWithProxy(
            "http://54.167.110.190/api/get-cities.php?country=ESP"
          );
          result.innerHTML = `<strong>Éxito:</strong><br>${JSON.stringify(
            data,
            null,
            2
          )}`;
        } catch (error) {
          result.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
      }

      async function testLoadCities() {
        const countryCode = document.getElementById("testCountry").value;
        const citySelect = document.getElementById("testCities");
        const result = document.getElementById("loadCitiesResult");

        if (!countryCode) {
          result.innerHTML = "Selecciona un país primero";
          return;
        }

        result.innerHTML = "Cargando...";
        citySelect.innerHTML = '<option value="">Cargando ciudades...</option>';

        try {
          const apiUrl = `http://54.167.110.190/api/get-cities.php?country=${countryCode}`;
          console.log(`URL: ${apiUrl}`);

          const data = await fetchWithProxy(apiUrl);
          console.log("Datos recibidos:", data);

          const citiesArray = data.cities || data.data || [];

          if (
            data.success &&
            Array.isArray(citiesArray) &&
            citiesArray.length > 0
          ) {
            citySelect.innerHTML =
              '<option value="">Selecciona una ciudad</option>';

            citiesArray.forEach((city) => {
              const cityId = city.ID || city.id;
              const cityName = city.Name || city.city_name || city.name;

              if (cityId && cityName) {
                const option = document.createElement("option");
                option.value = cityId;
                option.textContent = cityName;
                citySelect.appendChild(option);
              }
            });

            result.innerHTML = `<strong>Éxito:</strong> ${citiesArray.length} ciudades cargadas`;
          } else {
            // Usar respaldo
            if (typeof loadFallbackCities === "function") {
              loadFallbackCities(countryCode);
              result.innerHTML = "<strong>Usando datos de respaldo</strong>";
            } else {
              citySelect.innerHTML =
                '<option value="">No se encontraron ciudades</option>';
              result.innerHTML =
                "<strong>Error:</strong> No hay ciudades disponibles";
            }
          }
        } catch (error) {
          console.error("Error:", error);
          result.innerHTML = `<strong>Error:</strong> ${error.message}`;

          // Usar respaldo
          if (typeof loadFallbackCities === "function") {
            loadFallbackCities(countryCode);
            result.innerHTML += "<br><strong>Usando datos de respaldo</strong>";
          }
        }
      }

      // Función mock para las notificaciones
      function showNotification(message, type) {
        console.log(`Notificación [${type}]: ${message}`);
      }

      // Simular el elemento de ciudades para el respaldo
      function loadFallbackCities(countryCode) {
        const citySelect = document.getElementById("testCities");
        const countryCities = FALLBACK_CITIES[countryCode] || [];

        if (countryCities.length > 0) {
          citySelect.innerHTML =
            '<option value="">Selecciona una ciudad</option>';

          countryCities.forEach((city) => {
            const option = document.createElement("option");
            option.value = city.ID;
            option.textContent = city.Name;
            citySelect.appendChild(option);
          });

          console.log(`${countryCities.length} ciudades de respaldo cargadas`);
        } else {
          citySelect.innerHTML =
            '<option value="999">Ciudad no especificada</option>';
        }
      }
    </script>
  </body>
</html>
